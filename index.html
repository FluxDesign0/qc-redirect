<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Upload Foto con ID</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    img { max-width: 300px; display: block; margin-top: 10px; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Caricamento Foto</h1>
  <div>ID: <span id="idDisplay"></span></div>
  <div id="status">Caricamento stato...</div>
  <div>
    <img id="photoPreview" src="" alt="Nessuna foto caricata" style="display:none;">
  </div>
  <div>
    <input type="file" id="fileInput" accept="image/*" capture="environment">
    <button id="uploadBtn" disabled>Carica Foto</button>
  </div>

  <script>
    (function() {
      // URL del proxy Cloudflare (modificare con il vostro URL)
      const PROXY_URL = "https://IL_TUO_WORKER.workers.dev";
      // Estrae ID da ?id=... nella querystring
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      const idDisplay = document.getElementById('idDisplay');
      const statusDiv = document.getElementById('status');
      const imgPreview = document.getElementById('photoPreview');
      const fileInput = document.getElementById('fileInput');
      const uploadBtn = document.getElementById('uploadBtn');

      // Controlla la presenza di ID
      if (!id) {
        statusDiv.textContent = "Errore: parametro ID mancante nell'URL.";
        return;
      }
      idDisplay.textContent = id;

      // Funzione per gestire risposta JSON/errore
      async function handleResponse(response) {
        if (!response.ok) {
          let text = await response.text();
          throw new Error(`HTTP ${response.status}: ${text}`);
        }
        return response.json();
      }

      // Richiede lo stato della foto (GET ?action=meta&id=...)
      async function checkMeta() {
        try {
          const url = `${PROXY_URL}?action=meta&id=${encodeURIComponent(id)}`;
          const response = await fetch(url, { method: 'GET' });
          const data = await handleResponse(response);
          // Assumiamo che data abbia { exists: boolean, url?: string }
          if (data.exists) {
            statusDiv.textContent = "Foto trovata. Visualizzo anteprima.";
            if (data.url) {
              imgPreview.src = data.url;
              imgPreview.style.display = "block";
            } else {
              statusDiv.textContent += " (URL immagine mancante)";
            }
          } else {
            statusDiv.textContent = "Nessuna foto esistente per questo ID. Carica una nuova foto.";
          }
        } catch (err) {
          statusDiv.textContent = "Errore GET: " + err.message;
        }
      }

      // Preview dell'immagine selezionata
      fileInput.addEventListener('change', function() {
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            imgPreview.src = e.target.result;
            imgPreview.style.display = "block";
          };
          reader.readAsDataURL(file);
          uploadBtn.disabled = false;
        }
      });

      // Upload della foto selezionata (POST form-data)
      uploadBtn.addEventListener('click', async function() {
        const file = fileInput.files[0];
        if (!file) {
          alert("Seleziona un file prima di caricare.");
          return;
        }
        statusDiv.textContent = "Caricamento in corso...";
        try {
          const formData = new FormData();
          formData.append('id', id);
          formData.append('photo', file, file.name);
          const response = await fetch(PROXY_URL, { method: 'POST', body: formData });
          const data = await handleResponse(response);
          statusDiv.textContent = "Upload completato: " + JSON.stringify(data);
        } catch (err) {
          statusDiv.textContent = "Errore POST: " + err.message;
        }
      });

      // Avvia controllo all'avvio
      checkMeta();
    })();
  </script>
</body>
</html>
